---
title             : "Validation of the Utrecht Work Engagement Scale (UWES) in the Czech Republic"
shorttitle        : "Validation of UWES"
author: 
  - name          : "Haveri Martin"
    affiliation   : "1"
    role:         # Contributorship roles (e.g., CRediT, https://casrai.org/credit/)
      - Conceptualization
      - Writing - Original Draft Preparation
      - Writing - Review & Editing
  - name          : "Lukas Novak"
    address       : "Univerzitni 244/22, 771 11, Olomouc, Czech Republic"
    email         : "lukas.novak@oushi.upol.cz"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    role:
      - Writing - Review & Editing, 
      - Writing - Original Draft Preparation
      - Writing - Review & Editing
      - statistical analysis
  - name          : "Iva Polackova Solcova"
    affiliation   : "1,2"
    role:
      - Writing - Review & Editing
  - name          : "Peter Tavel"
    affiliation   : "1"
    role:
      - Writing - Review & Editing

affiliation:
  - id            : "1"
    institution   : "Palacky University Olomouc - Social Health Institute"
  - id            : "2"
    institution   : "The Czech Academy of Sciences, Institute of Psychology, Prague, Czech Republic"


authornote: |



abstract: |
  One or two sentences providing a **basic introduction** to the field,  comprehensible to a scientist in any discipline.
  
  Two to three sentences of **more detailed background**, comprehensible  to scientists in related disciplines.
  
  One sentence clearly stating the **general problem** being addressed by  this particular study.
  
  One sentence summarizing the main result (with the words "**here we show**" or their equivalent).
  
  Two or three sentences explaining what the **main result** reveals in direct comparison to what was thought to be the case previously, or how the  main result adds to previous knowledge.
  
  One or two sentences to put the results into a more **general context**.
  
  Two or three sentences to provide a **broader perspective**, readily comprehensible to a scientist in any discipline.
  
  <!-- https://tinyurl.com/ybremelq -->
  
keywords          : "keywords"
wordcount         : "X"

bibliography      : ["r-references.bib"]

floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no

documentclass     : "apa6"
classoption       : "man"
output            : papaja::apa6_word
---

```{r setup, include = FALSE}
library("papaja")
r_refs("r-references.bib")
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(87257413)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

```{r loading libraries, include=FALSE}
packages=c("psych","dplyr","lavaan","base","foreign","Routliers","MVN","parameters", "EFA.MRFA","RGenData","semPlot","psycho","apa","corx","effectsize","qwraps2","finalfit","ggstatsplot","dunn.test","devtools","rticles","ICC.Sample.Size","tidyverse","magrittr","osfr","expss","gtsummary","huxtable","equaltestMI","haven","rcompanion","ufs","semTools","semPlot","insight","flextable") 

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages], repos = "https://cran.r-project.org/")
}
# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
#________________________________________________________________________-
# instal MissMach currently not on the CRAN
miss.mach.url= "https://cran.r-project.org/src/contrib/Archive/MissMech/MissMech_1.0.2.tar.gz"
Miss.Pack=any(rownames(installed.packages()) == "MissMech")
if (any(Miss.Pack == FALSE)) {
  install.packages(miss.mach.url, repos=NULL, type="source")
}
library(MissMech)
#________________________________________________________________________-
# instal citr currently not on the CRAN
Miss.Pack=any(rownames(installed.packages()) == "citr")
if (any(Miss.Pack == FALSE)) {
  devtools::install_github("crsh/citr")
}
library("citr")
#________________________________________________________________________-
# install papaja currently not on the CRAN
Miss.Pack=any(rownames(installed.packages()) == "papaja")
if (any(Miss.Pack == FALSE)) {
  devtools::install_github("crsh/papaja")
}
library("papaja")
#________________________________________________________________________-
```

# Introduction

\newpage

# Methods
  
```{r data load and variable recode, include=FALSE}
path_to_dat = paste0(getwd(),"/Data")
data.raw=readRDS(paste0(path_to_dat,"/UWES_study.Rds"))
#_______________________________________________________________________
# variable recode
data.rec = data.raw %>% 
  rename("Religiosity" = "Religiosity",
         "Work_position" = "work_position") %>% 
    mutate(across(tidyr::starts_with(c("BFI_A_1","BFI_A_3",
                                     "BFI_A_6","BFI_A_8")), ~dplyr::recode(., 
                                                                       "1"= 5,
                                                                       "2"= 4,
                                                                       "3"= 3,
                                                                       "4"= 2,
                                                                       "5"= 1)),
           across(tidyr::starts_with(c("BFI_N_2","BFI_N_5","BFI_N_7")), ~dplyr::recode(., 
                                                                       "1"= 5,
                                                                       "2"= 4,
                                                                       "3"= 3,
                                                                       "4"= 2,
                                                                       "5"= 1)),
  # mutate(across(starts_with(c("obtize_","hlth_","UWES_","ODSIS_","BFI_","Age")), ~ as.numeric(.))) %>% # this can be deleted if not used    
         BFI_N = rowSums(across(starts_with("BFI_N_"))),
         BFI_A = rowSums(across(starts_with("BFI_A_"))),
  # rename(hlth_for_wom_pain_in_the_small_ = hlth_women_pain_in_small_etc) %>%  # this can be deleted if not used
  UWES = rowSums(across(starts_with("UWES_")))) %>%  # this can be deleted if not used
  mutate(Education = recode_factor(Education, 
                                   "Basic school" = "Basic school", 
                                   "Vocational school or non - maturity high school" = "Vocational school or non graduation high school",
                                   "High school" = "High school",
                                   "Higher vocational school" = "Higher vocational school or University",
                                   "University bachelor" = "Higher vocational school or University",
                                   "University master" = "Higher vocational school or University",
                                   "University Dr" = "Higher vocational school or University",
                                   "other: Ph.D." = "Higher vocational school or University"), 
                    Economical_status = recode_factor(Economical_status, 
                                            "Student" = "Without work",
                                            "Invalidy pensioner" = "Pensioner", 
                                            "Employed" = "Working",
                                            "Enterpreanuer" = "Working",
                                            "Not working" = "Without work",
                                            "Pensioner"="Pensioner",
                                            "Maternity leave"="Without work",
                                            "Without work" = "Without work",
                                            "In household" = "Without work",
                                            "other: invalidní duchod" = "Pensioner",
                                             .default = NA_character_),
         Religiosity = recode_factor(Religiosity,
                               "Yes, I am a member or church/rel.society" = "Yes, I am a member of church",
                               "Yes, but I am not a member of church/rel.society" = "Yes, but I am not a member of a church"),
         Work_position = recode_factor(Work_position,
                                       "Worker" = "Worker",
                                       "Professional worker" = "Professional worker",
                                       "Chief worker" = "Chief worker",
                                       "High rank worker" = "Chief worker"))

# filtering only those being working
data.work = data.rec %>% 
  filter(Economical_status == "Working")

# selecting only high quality respondents
data = data.work %>% 
  filter(low_q_res == "HQ") %>% 
  mutate_if(is.factor, droplevels)


# if not used the following can be deleted
#................................................................................
# data.vacc = data.vacc %>% 
#     mutate(hlth_depression_anxiety = case_when(
#     hlth_psych_anxiety == "1" | 
#     hlth_psych_depress == "1" ~ 1, 
#     TRUE ~ 0
#   ))

# summ of all deseases
# data.vacc = data.vacc %>% 
#   mutate(General_health = rowSums(across(starts_with(c("hlth_")))))
#................................................................................

# per.male_female.pa=table(data.pa$Gender)/length(data.pa$Gender) 
per.male_female.s1=table(data$Gender)/length(data$Gender) 
```

```{r outliers screening Sample 1, inconsistent responding detection, include=FALSE}
# calculating MAD 
out_MAD.1.dat=outliers_mad(data$UWES, b = 1.4826,threshold = 2.5, na.rm = T) 
```

```{r missing data analysis, include=FALSE}
MCAR.t=MissMech::TestMCARNormality(data = select(.data = data, starts_with(c("UWES_",
                                                                             #"BFI_",
                                                                             "vyska",
                                                                             "vaha",
                                                                             "worked_years",
                                                                             "work_contract_length"))))
```

```{r multivariate normality, include=FALSE}
# MULTIVARIATE NORMALITY 
# UWES
mvn(data = select(.data = data, starts_with("UWES_")),
    mvnTest = "mardia", univariatePlot = "histogram")

# summary: normality in UWES can be rejected  
```

```{r Homoscedasticity_and_other_assumptions, include=FALSE}
# fake regression 
random=rchisq(nrow(data), 5) # generate random data
fake_regres=lm(random~., data= data %>% select(starts_with("UWES_"))) # run fake regression
# run diagnostics plots 
plot(fake_regres) 
# testing homogenity of variances
bp.t.1 = car::ncvTest(fake_regres) # homogeneity of variances can be rejected
# bp.t.1=lmtest::bptest(fake_regres) 
```

## Participants  
  From the survey, we excluded participants being either without work (*n* = `r nrow(filter(data.rec, Economical_status == "Without work"))`) or pensioners (*n* = `r nrow(filter(data.rec, Economical_status == "Pensioner"))`) resulting in `r nrow(data.work)` participants. To increase data quality, we removed subjects finishing the survey in a short period of time i.e. < 15 minutes (*n* = `r nrow(filter(data.rec, status == "SPEEDER"))`). The survey typically lasted > 30 minutes. We also excluded respondents answering discrepantly to quality check items (*n* = `r nrow(data.work)-nrow(data)-nrow(filter(data.rec, status == "SPEEDER"))`). These items included information about weight, height and age. Tolerance in these control questions was set on 2 kilograms, 2 centimeters, and 2 years respectively. After removal of these subjects, the final number of participants was `r nrow(data)` (Age: *M* = `r mean(data$Age, na.rm = T) %>% round(digits = 2)`, *SD* = `r sd(data$Age, na.rm = T) %>% round(digits = 2)`, Females: `r round(per.male_female.s1[["Female"]]*100,digits = 2)`%).   

## Measures

### Utrecht Work Engagement Scale (UWES)
  .................... 

## Data analysis
  Inspection of histograms and results of Martia test of multivariate skewness and kurtouses indicated that normality assumption is violated in the UWES items. Moreover, examination of residual plots and results of Breusch-Pagan test ($\chi^2$ = `r round(bp.t.1$ChiSquare,digits=2)`, *df* = `r bp.t.1$Df`, `r format_p(bp.t.1$p)`) suggested heteroscedasticity. Thus, methods not requering parametric assumptions were used. The Little MCAR test provided an evidence that missing values are mission on random. Thus, as there was not a large number of missing values (*n* = `r nrow(filter(data, is.na(UWES_9)))`), incomplete cases were deleted listwise.
  Factor structure of the instrument was investigated via Confirmatory Factor Analysis (CFA). Original 3 dimensional factor structure was tested along with two and one factor solution reported across studies see @Kulikowski_2017. Item composition of tested factor solutions can be found in the study of @Willmer_2019. Kaiser Meyer Olkin (KMO) measure together with Bartlett test of sphericity were applied to assess factorability of the UWES data. Five indices were used to inspect model fit: 1) Mean Square Error of Approximation (RMSEA); 2) Standardized Root Mean Square Residual (SRMR); 3) chi-square test; 4) Comparative Fit index (CFI) and 5) Tucker-Lewis index (TLI). In the first two indices, values below reflects an acceptable fit and below 0.05 a good fit [@civelek2018essentials; @hoe_issues_2008; @vandenberg_review_2000; @hooper_structural_2008]. In the last two indices, values above 0.95 suggest an acceptable fit [@jackson_reporting_2009] and above 0.97 a good fit [@schermelleh_engel_evaluating_2003]. Diagonally Weighted Least Squares estimator (DWLS) on polychoric correlation matrix was used to fit CFA models.  
  Invariance of a measurement was explored in males and females. Configural, metric, scalar and strict invariance was assessed by CFA: if $\Delta$ CFA was > 0.01, than difference exists between invariance models [@Putnick_Bornstein_2016]. The scale reliability was measured by the McDonald’s $\omega$ and also by the Cronbach’s $\alpha$. Divergent validity was measured by associaotion of the UWES with xxx and xxx. During divergent validity testing, UWES subscale score was regressed on xxxx and xxxx. Convergent validity was inspected by associations with xxx and xxx.
  Comparison between socio-demographic groups in the UWES total and subscale score, was conducted by Mann–Whitney U test and by Kruskal–Wallis test. For post-hoc testing, Games-Howell and Dunn test were utilized. Effect size was reported in Vargha and Delaney $\hat{A}$ [@vargha_critique_2000]. The interpretation of the $\hat{A}$ is as follows: small effect (0.56 - 0.64), medium effect (0.64 - 0.71), large effect (> 0.71). All statistical calculations were conducted in `r cite_r()`. Primary packages used for analysis included: *lavaan* [@R-lavaan], *papaja* [@R-papaja] *psych* [@R-psych], *usf* [@R-ufs].     
  
# Results

## Socio-demographic results

```{r socio-demographic group comparison and descriptives, include=FALSE}
# UWES
# Gender
car::leveneTest(as.numeric(data$UWES) ~ data$Gender, data = data, center = mean) 
# Education
car::leveneTest(as.numeric(data$UWES) ~ data$Education, data = data, center = mean) # heteroscedasticity
# Religiosity
car::leveneTest(as.numeric(data$UWES) ~ data$Religiosity, data = data, center = mean) 
# Family status
car::leveneTest(as.numeric(data$UWES) ~ data$Family_status, data = data, center = mean) 
# Work_position
car::leveneTest(as.numeric(data$UWES) ~ data$Work_position, data = data, center = mean) # heteroscedasticity
#....................................................................................................................
```

```{r table one - first part from UWES total score}
desc.table = data %>%
    pivot_longer(c("Gender","Education", "Family_status", "Religiosity","Work_position"),
                 names_to = "key", values_to = "value") %>%
    group_by(key,value) %>%
    summarise (mean = round(mean(UWES, na.rm = T),digits = 2),
               sd = round(sd(UWES, na.rm = T),digits = 2),
               n = n()) %>%
  mutate(percent = n / sum(n)*100)


data.to.exper = data %>%
    pivot_longer(c("Gender","Education","Family_status","Religiosity","Work_position"),
                 names_to = "key", values_to = "value") %>%
    group_by(key,value) %>%
    summarise (mean = round(mean(UWES, na.rm = T),digits = 2),
               sd = round(sd(UWES, na.rm = T),digits = 2),
               UWES = UWES,
               n = n()) %>% 
  mutate(percent = n / sum(n)*100) 

#..............................................................................................
# By the command below, there is need to explore, where are significnat differences between socio-demographic groups
#..............................................................................................
 stat.tab=
     data.to.exper %>%
     group_by(key) %>% 
     do(., kruskal.test(.$UWES~.$value) %>% tidy) %>% 
     mutate(UWES = "UWES") %>%
     mutate(firstrowforvar=T) %>% 
     select(key, UWES, statistic, parameter, p.value, firstrowforvar) 

 table1.categorical.both <- desc.table %>%
   group_by(key) %>%
   # we join on firstrowforvar to make sure we don't duplicate the tests
   mutate(firstrowforvar=row_number()==1) %>%
   left_join(., stat.tab, by=c("key", "firstrowforvar")) %>%
   # this is gross, but we don't want to repeat the variable names in our table
   ungroup() %>%
   mutate(Variables = ifelse(firstrowforvar==T, as.character(key), NA)) %>%
   select(Variables, value, n, percent,mean,sd, statistic, parameter, p.value)
#..............................................................................................
# there are significat differences in: Education, Family status and work_position 
#..............................................................................................
# removing results of Kruscal-Wallis test
table1.categorical.both = table1.categorical.both %>% 
  select(Variables,value,n, percent,mean,sd) %>% 
  mutate(mean = str_replace(mean, "NaN", NA_character_)) %>% 
  janitor::remove_empty(which = c("rows")) %>% 
  filter(!is.na(value) & !is.na(mean)) # removing missing values
#.............................................................................
#.............................................................................
# post hoc testing
#.............................................................................
#.............................................................................
# Games-Howell for Education 
oa.edu=rstatix::games_howell_test(UWES ~ Education, data = data, detailed = T) 
# Dunn test 
dunn.test(data$UWES, data$Education, list = T, altp = T, method = "bonferroni", kw=T, label = T, table = T)
# selecting significnat results from Games-Howell
edu.join=oa.edu %>% filter(p.adj < 0.05) %>%
  select(group1,group2,df,statistic,p.adj) %>%
  rename(value=group1)
#  Merging into table 1  
table.continuous =
  full_join(table1.categorical.both, edu.join)
# merging ES into table 1 
# extracting significant comparistons from the Post-hoc test
edu.es.g=oa.edu %>%
  filter(p.adj < 0.05) %>% 
  select(group1,group2)
# extracting ES from VDA
ES.edu=multiVDA(x = data$UWES, g = data$Education, statistic = "VDA", digits = 2) %>%
  as.data.frame() %>%
  separate(col = pairs.Comparison, sep = " - ", into = c("group1","group2")) %>% 
  filter(group1 == edu.es.g$group1 & group2 == edu.es.g$group2) %>%  
  select(group1,group2,pairs.VDA) %>% 
  rename(value = group1)
#  Merging into table 1  
table.continuous =
  full_join(table.continuous, ES.edu)
#................................................
# Family status 
#................................................
# Games-Howell for Family status 
uwes.fs=rstatix::games_howell_test(UWES ~ Family_status, data = data, detailed = T) 
# Dunn test 
# du=FSA::dunnTest(UWES~ Family_status,data = data, method="bonferroni")
# du=du$res %>% as_tibble()
# after post hoc testing, the resutls were not significant
#................................................
# Work_position
#................................................
# Dunn test 
dunn.test(data$UWES, data$Work_position, list = T, altp = T, method = "bonferroni", kw=T, label = T, table = T)
# Games-Howell for Work_position 
uwes.wp=rstatix::games_howell_test(UWES ~ Work_position, data = data, detailed = T) 
# selecting significnat results from Games-Howell
uwes.join=uwes.wp %>% filter(p.adj < 0.05) %>%
  select(group1,group2,df,statistic,p.adj) %>%
  rename(value=group1)
#  Merging into table 1  
table.continuous.2 =
  full_join(table1.categorical.both, uwes.join)
# merging ES into table 1 
# extracting significant comparistons from the Post-hoc test
wp.es.g=uwes.wp %>%
  filter(p.adj < 0.05) %>% 
  select(group1,group2)
# extracting ES from VDA
ES.wp=multiVDA(x = data$UWES, g = data$Work_position, statistic = "VDA", digits = 2) %>%
  as.data.frame() %>%
  separate(col = pairs.Comparison, sep = " - ", into = c("group1","group2")) %>% 
  filter(group1 == wp.es.g$group1 & group2 == wp.es.g$group2) %>%  
  select(group1,group2,pairs.VDA) %>% 
  rename(value = group1)
#  Merging into table 1  
table.continuous.2 =
  full_join(table.continuous.2, ES.wp)

# removing empty rows and NaNs 
two.var.tab=full_join(table.continuous, table.continuous.2) %>%
    mutate(mean = str_replace(mean, "NaN", NA_character_)) %>% 
  janitor::remove_empty(which = c("rows"))

# removing duplicites
two.var.tab = two.var.tab %>%
  group_by(Variables, value) %>% 
  mutate(duplicate = n()) %>% # count number of duplicite cases
  mutate(to.rm = ifelse(duplicate > 1 & is.na(group2),TRUE,FALSE)) %>%  
  filter(to.rm == FALSE) %>% 
  ungroup() %>% 
  select(!c("to.rm","duplicate"))

# sorting working status - extracting positions from original data frame
  sort.bypos = data$Work_position %>% levels()  # selecting order based on which we want to sort variable
  
# arranging
  two.var.tab = two.var.tab %>% 
  arrange(factor(value, levels = sort.bypos)) %>%  
# removing duplicate variable names
  mutate(to.rm2 = ifelse(duplicated(Variables) & !is.na(Variables),TRUE,FALSE)) %>% 
  mutate(Variables = ifelse(to.rm2 == TRUE,NA_character_, Variables)) %>% 
  select(!c("to.rm2"))
#................................
# formatting table
#...............................
two.var.tab = two.var.tab %>% 
  mutate("(M±sd)" = paste0("","(",mean,"±",sd,")"),
         "n(%)" = paste0("",n," ","(",round(percent,digits = 0),"%)"),
         Gr.dif.UWES.total = paste0("",group2,": ","x2(",round(df,digits = 0),")","=",round(statistic,digits = 2),
                                    "", format_p(p.adj,stars_only = T),", A=",pairs.VDA), # there are stars only to save space
         Gr.dif.UWES.total = str_replace(Gr.dif.UWES.total, pattern = "(?<=^NA:)( .*)", replacement = ""),
         Gr.dif.UWES.total = str_replace(Gr.dif.UWES.total, pattern = "^NA:", replacement = "")) %>% 
  select(Variables,value,"n(%)","(M±sd)",Gr.dif.UWES.total) 
```

```{r, echo=FALSE}
two.var.tab %>%  
  as_tibble() %>% 
  mutate_all(~(replace(., is.na(.), ""))) %>%
  as_huxtable(add_colnames = F) %>% 
  set_bottom_border(row = 1, value = 1) %>%  # the 1 here indicates the rownumber 
  set_font("times") %>% 
  set_font_size(10) %>% 
  apa_table(caption = "Socio-demographic results of the three samples", span_text_columns = F)
```

```{r Bartlett test and KMO, include=FALSE}
# POLYCHORIC CORELATION MATRIX
# UWES 
UWES.rep.poly = data %>% select(starts_with("UWES_")) %>% lavCor(ordered = T)
# BARTLETS TEST OF SPHERICITY:
bartlett.UWES=cortest.bartlett(UWES.rep.poly, diag = T, n=nrow(data)) #  Bartlett's test of sphericity 
# KMO
KMO(UWES.rep.poly) # 0.96
```

```{r CFA UWES - three fac, include=FALSE}
# three factor model 
three.fac.mod = "Vigor =~ UWES_1 + UWES_2 + UWES_5 
               Dedication =~ UWES_3 + UWES_4 + UWES_7
               Absorption =~ UWES_6 + UWES_8 + UWES_9"
# when "ordered" is set to "TRUE", than DWLS estimator is automatically used as "standard" in results. 
# "Robust" chisquare in results is referring to WLSMV estimator.
UWES.three.fac=sem(model = three.fac.mod, data = data, std.lv=T, ordered = T)
three.fac.mod.sum=summary(UWES.three.fac,rsquare=T, standardized=T, fit.measures=T)
modificationindices(UWES.three.fac, sort. = T) # how can we improve our model
# inspection of correlation between residuals
# Large positive values indicate the model underpredicts the correlation; large negative values suggest overprediction of the correlation. Usually values |r>.1| are worth closer consideration.
resid(UWES.three.fac, "cor")

mod.fit.indicies=c("Three factor model", as.table(fitMeasures(UWES.three.fac)[c('chisq', 'df', 'pvalue',
                                                              'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                              "rmsea.ci.upper", 'srmr')]) %>% round(digits = 3)) %>% t() 
```

```{r Figure 1, echo=FALSE, message=FALSE, warning=FALSE}
semPaths(UWES.three.fac,layout = "tree2", whatLabels= "std",
         residuals = T, thresholds = F,        
         reorder = T, edge.label.cex= 1, fade=F, 
         intercepts = F, rotation = 1,  
         nCharNodes = 20,style = "OpenMx", edge.label.position = 0.56,
         sizeLat = 9, sizeMan=8,edge.color="black")
```

```{r CFA two factor model, include=FALSE}
# two factor model 
two.fac.mod="VigDeg =~ UWES_1 + UWES_2 + UWES_3 + UWES_4 + UWES_5 + UWES_7
             Abs =~  UWES_6 + UWES_8 + UWES_9"

#when "ordered" is set to "TRUE", than DWLS estimator is auto  matically used as "standard" in results. "Robust" chisquare in results is referring to WLSMV estimator.
UWES.two.fac=sem(model = two.fac.mod, data = data, std.lv=T, ordered = T)
two.fac.mod.sum=summary(UWES.two.fac,rsquare=T, standardized=T, fit.measures=T)
parameterestimates(UWES.two.fac, standardized = T) # whill show standardized estimates and many other things
modificationindices(UWES.two.fac, sort. = T) # how can we improve our model
fitmeasures(UWES.two.fac) # chisq.scaled - robust one
# exporting fit indexes
mod.fit.indicies =
  c("Two factor model", as.table(fitMeasures(UWES.two.fac)[c("chisq", "df", 'pvalue',
                                                                           'cfi',"tli",'rmsea',"rmsea.ci.lower", 
                                                                           "rmsea.ci.upper", 'srmr')]) %>% 
      round(digits = 3)) %>%
  t() %>%
  rbind(mod.fit.indicies)


one.fac.mod.cor.er.UWES.resid=resid(UWES.two.fac, "cor")
dif.test.two.three.fac=lavaan::anova(UWES.three.fac,UWES.two.fac, method = "satorra.bentler.2010")
```

```{r CFA one factor model, include=FALSE}
# one factor model 
one.fac.mod="WE =~ UWES_1 + UWES_2 + UWES_3 + UWES_4 + UWES_5 + UWES_6 + UWES_7 + UWES_8 + UWES_9"

#when "ordered" is set to "TRUE", than DWLS estimator is auto  matically used as "standard" in results. "Robust" chisquare in results is referring to WLSMV estimator.
UWES.one.fac=sem(model = one.fac.mod, data = data, std.lv=T, ordered = T)
one.fac.mod.sum=summary(UWES.one.fac,rsquare=T, standardized=T, fit.measures=T)
parameterestimates(UWES.one.fac, standardized = T) # whill show standardized estimates and many other things
modificationindices(UWES.one.fac, sort. = T) # how can we improve our model
fitmeasures(UWES.one.fac) # chisq.scaled - robust one
# exporting fit indexes
mod.fit.indicies =
  c("Two factor model", as.table(fitMeasures(UWES.one.fac)[c("chisq", "df", 'pvalue',
                                                                           'cfi',"tli",'rmsea',"rmsea.ci.lower", 
                                                                           "rmsea.ci.upper", 'srmr')]) %>% 
      round(digits = 3)) %>%
  t() %>%
  rbind(mod.fit.indicies)


one.fac.mod.cor.er.UWES.resid=resid(UWES.one.fac, "cor")
dif.test.one.three.fac=lavaan::anova(UWES.three.fac,UWES.one.fac, method = "satorra.bentler.2010")
```

## Confirmatory Factor Analysis 
  Bartlett test ($\chi^2$ (`r bartlett.UWES$df`) = `r round(bartlett.UWES$chisq,digits=2)`, `r format_p(bartlett.UWES$p.value)`) as well as KMO (`r round(KMO(UWES.rep.poly)$MSA,digits = 2)`) revealed that UWES data are sufficiently correlated for confirmatory factor analysis. In the first step, original-three factor model was fitted. Results indicated a good fit of three dimensional solution (see Figure 1, Table 2). Modification indices did not suggested high change in $\chi^2$ in case of releasing constrains between UWES items. Factor loadings ($\lambda$) in the three factor solution were high (see Figure 1). Correlation between residuals in manifest variables was low: *r* = `r round(max(resid(UWES.three.fac, "cor")$cov), digits = 2)`. In the second step, two factor model was tested: results suggested that two-dimensional model yields lower model fit as compared to the original-three factor model (see Table 2). This was supported by the significant chi square difference test with Satorra Bentler correction: $\chi^2$(`r dif.test.two.three.fac$"Df diff"[2]`) = `r dif.test.two.three.fac$"Chisq diff"[2] %>% round(digits = 2)`; `r dif.test.two.three.fac$"Pr(>Chisq)" [2] %>% format_p`. Factor loadings of the two factor solution were high ranging from: `r round(min(select((filter(parameterestimates(UWES.two.fac,standardized = T), op %in% "=~")), std.all)), digits = 2)` to `r round(max(select((filter(parameterestimates(UWES.two.fac, standardized = T), op %in% "=~")), std.all)), digits = 2)`. Finally, fit of unidimensional solution was assessed: overall, this model had worst goodness of fit indices values and factor loadings ($\lambda$ =`r round(min(select((filter(parameterestimates(UWES.one.fac,standardized = T), op %in% "=~")), std.all)), digits = 2)` - `r round(max(select((filter(parameterestimates(UWES.one.fac, standardized = T), op %in% "=~")), std.all)), digits = 2)`) as compared with two and three factor model (see Table 2). The Chi square difference test suggested lower fit of unidimensional solution as compared with the three factor solution: $\chi^2$(`r dif.test.one.three.fac$"Df diff"[2]`) = `r dif.test.one.three.fac$"Chisq diff"[2] %>% round(digits = 2)`; `r dif.test.one.three.fac$"Pr(>Chisq)" [2] %>% format_p`. Taken together, this results supports superiority the original-three factor model over two and one factor solution in terms of fit with the data.                         


\newpage
After modification of the base model, fit indices yielded an excellent values: $\chi^2$(`r round(two.fac.mod.sum$FIT[["df"]], digits = 2)`) = `r round(two.fac.mod.sum$FIT[["chisq"]], digits = 2)`, `r format_p(two.fac.mod.sum$FIT[["pvalue"]])`, CFI=`r round(two.fac.mod.sum$FIT[["cfi"]], digits = 3)`,TLI=`r round(two.fac.mod.sum$FIT[["tli"]], digits = 3)`,SRMR=`r round(two.fac.mod.sum$FIT[["srmr"]], digits = 3)`, RMSEA=`r round(two.fac.mod.sum$FIT[["rmsea"]], digits = 3)`, 90% CI[`r round(two.fac.mod.sum$FIT[["rmsea.ci.lower"]], digits = 3)`-`r round(two.fac.mod.sum$FIT[["rmsea.ci.upper"]], digits = 3)`]. Chi-square difference test supported better fit of the model with correlated residuals: $\chi^2$(`r dif.test.two.three.fac$"Df diff"[2]`) = `r dif.test.two.three.fac$"Chisq diff"[2] %>% round(digits = 2)`; `r dif.test.two.three.fac$"Pr(>Chisq)" [2] %>% format_p `. In modified model, the correlation between items residuals was low with maximum value of `r round(max(one.fac.mod.cor.er.UWES.resid$cov), digits = 2) `. Factor loadings of manifest variables were high (Figure 1). 
```{r correlation table one, eval=FALSE, include=FALSE}
variab.cor.data.pa=data.pa[, c("UWES","ODSIS","Gender","BFI_N","RSES","Age","education")]
# recode variables to numeric
variab.cor.data.pa = variab.cor.data.pa %>% 
  mutate_all(as.numeric)

iter.cor.teq.fin.data.pa=corx(variab.cor.data.pa, method = "spearman", triangle = "lower", describe = c(M = mean, SD = sd), stars = c(0.05, 0.01, 0.001),note = "M = mean, SD = standard devation")
iter.cor.teq.fin.data.pa
```

```{r print cor table pa data, eval=FALSE, include=FALSE}
apa_table(iter.cor.teq.fin.data.pa$apa, caption = "Correaltion table with means and standard devations",
          note = "* p < 0.05; ** p < 0.01; *** p < 0.001; SD = standard deviation, M = mean, UWES = Overall Anxiety Severity and Impairment Scale, ODSIS = Overall Depression Severity and Impairment Scale, RSES = Rosenberg Self Esteem Scale, BFI_N = Big Five Inventory - Neuroticism subscale. Spearman rank correlations were used") 
```

## Invariance testing and factor loadings 

```{r gender invariance UWES, include=FALSE}
meas.invar.UWES = "WA =~ UWES_1 + UWES_2 + UWES_3 + UWES_4 + UWES_5 + UWES_6 + UWES_7 + UWES_8 + UWES_9"

meas.invar.UWES.cfa=cfa(meas.invar.UWES, data = data,ordered = T,std.lv=T,
                         meanstructure = T) # crucial in invariance testing
# Tab x 
tab.fit = matrix(nrow = 7, ncol = 10)
# ODSIS Part

colnames(tab.fit)=c("Model","x2","df","pvalue","CFI","TLI","rmsea","rmsea.ci.lower", "rmsea.ci.upper", "SRMR")
tab.fit[1, ] = c("Overall model", round(fitMeasures(meas.invar.UWES.cfa,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))

data.invar = data %>%
  drop_na(UWES)

mult.group.m = eqMI.main(model = meas.invar.UWES,
                         data = data.invar,
                         group = "Gender", 
                         meanstructure = T,
                         output = "both",
                         equivalence.test = T,
                         adjRMSEA = T,
                         projection = T,
                         ordered = T)

# male table
tab.fit[2, ] = c("Male model", round(fitMeasures(mult.group.m$convention.sem$LavaanOut$fit.configural.g1,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))
# female table
tab.fit[3, ] = c("Female model", round(fitMeasures(mult.group.m$convention.sem$LavaanOut$fit.configural.g2,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))

# Configure invariance 
tab.fit[4, ] = c("Configural  model", round(fitMeasures(mult.group.m$convention.sem$LavaanOut$fit.combine.groups,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))
# Metric invariance 
tab.fit[5, ] = c("Metric  model", round(fitMeasures(mult.group.m$convention.sem$LavaanOut$fit.metric,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))
# Scalar invariance 
tab.fit[6, ] = c("Scalar  model", round(fitMeasures(mult.group.m$convention.sem$LavaanOut$fit.scalar,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))
# Strict (error) invariance
tab.fit[7, ] = c("Strict  model", round(fitMeasures(mult.group.m$convention.sem$LavaanOut$fit.strict.residuals,
                                                    c('chisq', 'df', 'pvalue',
                                                   'cfi',"tli",'rmsea',"rmsea.ci.lower",
                                                   "rmsea.ci.upper", 'srmr')), digits = 3))

mult.group.m$eqMI.stat # checking chi-square 

tab.fit = tab.fit %>% 
  as_tibble() %>% 
  mutate(rmsea = paste0(rmsea, " ","(",rmsea.ci.lower,"-",rmsea.ci.upper,")")) %>% 
  rename(
         "RMSEA (90% CI)" = "rmsea") %>% 
  select(!starts_with(c("rmsea.ci.","rmsea.ci.lower","rmsea.ci.upper"))) %>% view()
```
 Change in the CFI < 0.01 across configure, metric, scalar and strict models suggests measurement invariance of the UWES between the two genders (Table 3).
```{r}
# creating table 
tab.fit %>% 
  as_tibble() %>% 
     mutate_all(~(replace(., is.na(.), ""))) %>% 
  as_huxtable(add_colnames = F) %>% 
  apa_table(col.names=c("Model","x2","df","p-value","CFI","TLI","RMSEA","SRMR"),
          caption = "Measurement eqivalence of the UWES between genders", 
          note = "x2 = chi-square, df = degrees of freedom, CFI = Comparative Fit Index, TLI = Tucker-Lewis index, RMSEA = Root Mean Square Error of Approximation , CI = Confidence Interval, SRMR = Standardized Root Mean Square Residual")
```

## Internal consistency and item statistic
```{r internal consistency examination, include=FALSE}
# UWES
UWES.rel=ufs::scaleStructure(select(starts_with("UWES_"), .data = data), digits = 2, poly = TRUE, samples = 5000)
```
The UWES yielded an excellent internal consistency: with Cronbach's $\alpha$ = `r round(UWES.rel$intermediate$alpha.ordinal.ci$est,digits=2)` 95% CI[`r round(UWES.rel$intermediate$alpha.ordinal.ci$ci.lower,digits=2)` - `r round(UWES.rel$intermediate$alpha.ordinal.ci$ci.upper,digits=2)`] and McDonald's $\omega_t$ = `r round(UWES.rel$intermediate$omega.ordinal$est, digits=2 )` 95% CI[`r round(UWES.rel$intermediate[["omega.ordinal.ci"]]$ci.lower, digits = 2)` - `r round(UWES.rel$intermediate[["omega.ordinal.ci"]]$ci.upper, digits = 2)`]. Table 3 depicts statistic of the UWES items. Overall, correlations between these items and item-total correlations were high. The item 5 had the lowest correlation with scale items as well as item-total correlation.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# item statistic calculation
ITC.UWES=psych::alpha(x = select((starts_with("UWES_")),.data = data))
skew.kurt.UWES=describe(x = select(data, starts_with("UWES_")))

# calculating polychoric correlations 
UWES.cz.polych = polychoric(select((starts_with("UWES_")), .data = data), smooth = T) # polychoric correlation procedure
UWES.cz.polych$rho[upper.tri(UWES.cz.polych$rho)] <- NA # replacing the same values in matrix with na

# extract p values to poly correlations 
library(correlation)
library(gtools)
p.val.polych=cor_to_p(cor(select((starts_with("UWES_")),.data = data)), n = nrow(data),method = "polychoric")$p

# p-values to stars
stars.to.cor = p.val.polych %>% stars.pval()
# two digits 
UWES.cz.polych$rho = UWES.cz.polych$rho %>% round(digits = 2) 
# paste p-values
poly.mat.star <- matrix(paste(UWES.cz.polych$rho, stars.to.cor, sep=""), ncol=ncol(p.val.polych)) 
# adding colnames to poly cor table
rownames(poly.mat.star) <- colnames(p.val.polych) 
# pasting colnames and rownames to cor table
colnames(poly.mat.star) <- paste(colnames(p.val.polych), "", sep="") 
# remove upper triangular and 1 diagonal
poly.mat.star[upper.tri(poly.mat.star, diag = FALSE)] <- "" 
# adding 1 on the diagonal
poly.mat.star[upper.tri(poly.mat.star, diag = FALSE)] <- "" 
# removing stars from 1 at the diagonal
diag(poly.mat.star)=str_replace_all(diag(poly.mat.star), "[:punct:]", replacement = "")

# selecting mean,
M=round(ITC.UWES$item.stats$mean,digits = 2)
# selecting SD
SD=round(ITC.UWES$item.stats$sd,digits = 2)
# selecting ITC item-total correlation
ITC=round(ITC.UWES$item.stats$r.cor,digits = 2)
# selecting skewness
Skewness=round(skew.kurt.UWES$skew,digits = 2)
# selecting kurtosis
kurtosis=round(skew.kurt.UWES$kurtosis, digits = 2)

# combine all
UWES.items.des=cbind(poly.mat.star,M,SD,ITC,Skewness,kurtosis) 

##### This is for PDF output only
# knitr::kable(longtable = T, digits = 2,UWES.items.des, "latex", booktabs=T, linesep = "", caption = "Polychoric correlations of the UWES items with SD and M, ITC") %>% 
#   kableExtra::kable_styling(latex_options = c("scale_down", "hold_position"), font_size = 7) %>%  # full_width = T or longtable = T (to the Kable command)
#   kableExtra::footnote(c( "* p < 0.05; ** p < 0.01; *** p < 0.001, M = Mean, SD = Standard Deviation, ITC = Item-total correlation corrected for scale reliability and item overlap, IIC = Inter-item correlation"),
#            threeparttable=T, footnote_as_chunk = T)
```

```{r echo=FALSE}
# creating table 
UWES.items.des %>% 
  as_tibble(rownames = NA) %>% 
     mutate_all(~(replace(., is.na(.), ""))) %>% 
  as_huxtable(add_colnames = F) %>% 
  apa_table(
          caption = "Polychoric correlations of the UWES items with SD and M, ITC and IIC", 
          note = "* p < 0.05; ** p < 0.01; *** p < 0.001, M = Mean, SD = Standard Deviation, ITC = Item-total correlation corrected for scale reliability and item overlap")
```

## Convergent and divergent validity 

```{r The ANCOVA Gender, eval=FALSE, include=FALSE}
#UWES______________________________
# ANCOVA for further analysis
ancov.1=aov(UWES ~ Gender, data = data.ex) 
# ANCOVA with type III summ of squares
ancov.1.T.III.SS = ancov.1 %>% car::Anova(type="III") %>% print()
# APA format 
ancov.apa1=apa_print(ancov.1.T.III.SS)
# Neuroticism
#____________________________________________________________________________
# ANCOVA for further analysis
ancov.3=aov(UWES ~ Gender + BFI_N, data = data.ex) 
# ANCOVA with type III summ of squares
ancov.3.T.III.SS = ancov.3 %>% car::Anova(type="III") %>% print()
# APA format 
ancov.apa3=apa_print(ancov.3.T.III.SS)
#ODSIS______________________________

# robust version to check the results of parametric test 
WRS2::ancova(formula = UWES ~ Gender + BFI_N , data = data.ex) 
WRS2::ancova(formula = ODSIS ~ Gender + BFI_N , data = data.ex) 



# The first ANCOVA indicated that females score significantly higher score on anxiety with medium effect size `r ancov.apa1$full_result$Gender` and also in depression with small effect size: `r ancov.apa2$full_result$Gender`. After adding neuroticism as a covariate, the difference between males and females in anxiety `r ancov.apa3$full_result$Gender` and depression `r ancov.apa4$full_result$Gender` remained significant.
# 
# The table 4 represents bivariate zero-order correlations between main study variables. UWES positively correlated with depression, neuroticism, negative emotions experienced in past week and negatively correlated with self-esteem and age. Similarly, as the previous scale, ODSIS was positively correlated with neuroticism, negative emotions experienced in past week, anxiety and negatively correlated self-esteem and age. In the retest sample, positive association between UWES and GAD-7: `r apa_print(cor.test(ret.data$UWES_T2, ret.data$GAD_7, method = "spearman", exact = F))$full_result` and PHQ-9: `r apa_print(cor.test(ret.data$UWES_T2, ret.data$PHQ, method = "spearman", exact = F))$full_result` was found. When estimating correlation of ODSIS with GAD-7 and PHQ-9, due to low power, parametric correlations were used: ODSIS score positively correlated with GAD-7: `r apa_print(cor.test(ret.data$ODSIS_T2, ret.data$GAD_7, method = "pearson", exact = F))$full_result` and PHQ-9: `r apa_print(cor.test(ret.data$ODSIS_T2, ret.data$PHQ, method = "pearson", exact = F))$full_result`. Results of this parametric correlations should be however interpreted with caution.
```

```{r correlation table between study variables in the data.ex, eval=FALSE, include=FALSE}
variab.cor.data.ex=data.ex[, c("UWES","ODSIS","Gender","BFI_N","RSES","PANAS_P","PANAS_N","Age","education","Religiosity")]
# recode variables to numeric
variab.cor.data.ex = variab.cor.data.ex %>% 
  mutate_all(as.numeric)

variab.cor.data.ex.to.apa=corx(variab.cor.data.ex, method = "spearman", triangle = "lower", describe = c(M = mean, SD = sd), stars = c(0.05, 0.01, 0.001),note = "M = mean, SD = standard devation")
variab.cor.data.ex.to.apa
```

```{r print cor table ex data, eval=FALSE, include=FALSE}
apa_table(variab.cor.data.ex.to.apa$apa, caption = "Correaltion table with means and standard devations",
          note = "* p < 0.05; ** p < 0.01; *** p < 0.001; SD = standard deviation; M = mean; UWES = Overall Anxiety and Impairment Scale; ODSIS = Overall Depression and Impairment Scale; BFI_N = Big Five Inventory - Neuroticism subscale; RSES = Rosenberg Self-Esteem Scale; PANAS_P = The Positive and Negative Affect Schedule - Positive emotions subscale; PANAS_N = The Positive and Negative Affect Schedule - Negative emotions subscale; Correlations were calculated using Spearman rank correlation coeficient")
```

```{r test-retest reliability, eval=FALSE, include=FALSE}
# UWES
icc.UWES = ret.data %>% 
  select(UWES_T1,UWES_T2) %>% 
    irr::icc(model = "twoway",type = "agreement", unit= "average")
icc.UWES
# ODSIS
icc.odsis = ret.data %>% 
  select(ODSIS_T1,ODSIS_T2) %>% 
    irr::icc(model = "twoway",type = "agreement", unit= "average")
icc.odsis


# Intraclass correlations based on two-way random effects model revealed that UWES *r* = `r icc.UWES$value %>% round(digits = 2)`, 95% CI [`r round(icc.UWES$lbound,digits=2)` - `r round(icc.UWES$ubound,digits=2)`], `r icc.UWES$p.value %>% format_p` and ODSIS *r* = `r icc.odsis$value %>% round(digits = 2)`, 95% CI [`r round(icc.odsis$lbound,digits=2)` - `r round(icc.odsis$ubound,digits=2)`], `r icc.odsis$p.value %>% format_p` scores were relatively stable after one week.
```

# Cut-off points identification 

```{r cut-off, eval=FALSE, include=FALSE}
sens.spec.data = drop_na(sens.spec.data) # there is need to delete incomplete obervations
library(cutpointr)
oa.roc <- cutpointr(x = "UWES",class = "Anxiety", data = sens.spec.data, metric = youden, boot_runs = 1000, pos_class = "yes", neg_class = "No")
summary(oa.roc)
#_____________________________________________________________________________________
od.roc <- cutpointr(x = "ODSIS",class = "Depression", data = sens.spec.data, metric = youden, boot_runs = 1000, pos_class = "yes", neg_class = "No")
summary(od.roc)
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#True Positive Rate (TPR) indicates what proportion of people ‘anxiety’ were correctly classified.
UWES.tpr=cutpointr::roc(data = sens.spec.data, x = UWES, class = Anxiety,
pos_class = "yes", neg_class = "No")
round(boot_ci(oa.roc, variable = AUC, in_bag = TRUE, alpha = 0.05),digits = 2)[2] # CI for AUC
# ODSIS________________________________________________________________________________
odsis.tpr=cutpointr::roc(data = sens.spec.data, x = ODSIS, class = Anxiety,pos_class = "yes", neg_class = "No")
round(boot_ci(oa.roc, variable = AUC, in_bag = TRUE, alpha = 0.05),digits = 2)[2] # CI for AUC
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
sens.spec.dataa = drop_na(sens.spec.data) # there is need to delete incomplete obervations
library(pROC)
# UWES
UWES.cut=glm(Anxiety ~ UWES, data = sens.spec.dataa, family = "binomial")
# pROC::roc(sens.spec.dataa$Anxiety, UWES.cut$fitted.values, plot = T)
# par(pty = "s")
# plot.roc(sens.spec.dataa$Anxiety, UWES.cut$fitted.values, percent = T, asp = NA, col="#1c61b6", main="ROC curve of UWES")
# ____________________________________________________________________________________
```
   

# Discussion


\newpage

# References

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id="refs" custom-style="Bibliography"></div>
\endgroup
